# Open Component Model (OCM) — Claude Code Guidelines

## Agent Rules
- You are an expert Go developer.
- You are fluent in Kubernetes and its ecosystem.
- Be concise
- Use simple sentences. But feel free to use technical jargon.
- Do NOT over-explain basic concepts. Assume the user is technically proficient.
- DO NOT USE flattering, corporate-ish or marketing language. Maintain a neutral viewpoint.
- DO NOT USE vague and / or generic claims which may seem correct but are not substantiated by the the context.
- DO NOT comment on each and every line. Keep comments to a minimum.
- Follow idiomatic Go guidelines.

## Project Overview

OCM is a monorepo implementing the Open Component Model standard. Three main components:

- **CLI** (`cli/`) — Cobra-based CLI tool with 14 commands
- **Kubernetes Controller** (`kubernetes/controller/`) — controller-runtime based, 4 CRDs (v1alpha1): Component, Deployer, Repository, Resource
- **Go Bindings** (`bindings/go/`) — 23+ independently-versioned Go modules forming the shared library layer

Go 1.25.5. Go workspaces. Module paths: `ocm.software/open-component-model/bindings/go/...`

## Code Rules

### No Cross-Module Pollution
- Do not mix changes across multiple Go modules in a single PR
- Each PR should focus on a single module unless there is a clear dependency relationship
- The project contains 23+ independent modules in `bindings/go/`

### Follow Package Structure
- Respect the established package hierarchy and dependencies
- Maintain consistency with existing patterns in the target package

### Runtime Type System
- Verify correct usage of the runtime type system (`bindings/go/runtime/`)
- Every typed object has `runtime.Type` (Name + Version)
- Implement `runtime.Typed` interface
- Register types in `runtime.Scheme`
- Validate type conversions and runtime checks

### Controller Performance
- When modifying `kubernetes/controller/`, ensure no performance regressions
- Watch/list operations efficiency, reconciliation loop performance, memory usage, caching strategies

## Conventions

### Testing
- Use `testify/require` for assertions
- Pattern: `r := require.New(t)` at the start of tests
- Table-driven tests with `t.Run()` for subtests
- Unit tests: `*_test.go` alongside source
- Integration tests: separate `integration/` subdirectory with own `go.mod`
- Test data: embed using `//go:embed testdata`
- Conformance tests: `input.yaml`, `expected.json`, `README.md`
- Use `t.Context()` for `ctx` instead of `context.Background()` or `context.TODO()`

### Error Handling
```go
return fmt.Errorf("unable to open file: %w", err)
return errors.Join(ErrUnknown, fmt.Errorf("error: %w", err))
```
- Define sentinel errors: `var ErrNotFound = errors.New("credentials not found")`
- Check with `errors.Is()`. No complex error hierarchies.

### Code Generation
Three generators: `ocmtypegen`, `jsonschemagen`, `deepcopy-gen`

Markers:
```go
// +ocm:typegen=true
// +ocm:jsonschema-gen=true
// +k8s:deepcopy-gen=true
```
- Generated files use `zz_generated.*` prefix with build tag `//go:build !ignore_autogenerated`
- Run `task generate` after adding or modifying markers

### Import Order (gci-enforced)
```go
import (
    // 1. Standard library
    "context"
    "fmt"

    // 2. Blank imports
    _ "embed"

    // 3. Third-party
    "github.com/spf13/cobra"

    // 4. OCM modules
    "ocm.software/open-component-model/bindings/go/runtime"
)
```

### Commit Messages (enforced by CI)
```
type(scope): subject

feat(cli): add new command
fix(repository): handle nil pointer
chore(deps): update dependencies
```
Types: `feat`, `fix`, `chore`, `docs`, `test`, `perf`

Breaking changes: `feat(api)!: remove deprecated method`

### Documentation
- `doc.go` for package-level documentation
- ADRs in `docs/adr/` using template `docs/adr/0000_template.md`

### Module Versioning
- Lockstep MAJOR/MINOR versions across modules, independent PATCH
- Internal imports: `ocm.software/open-component-model/bindings/go/...`

## Build System

All automation uses **Task** (not Make).

```bash
task test              # Run unit tests
task test/integration  # Run integration tests
task build             # Build binaries
task generate          # Run all code generators
task tidy              # go mod tidy across all modules
task init/go.work      # Initialize Go workspace
```

## Common Workflows

### Adding a New Repository Type
1. Create module under `bindings/go/`
2. Implement `repository.ComponentVersionRepository` interface
3. Register type in scheme
4. Add `+ocm:typegen=true` and `+k8s:deepcopy-gen=true` markers
5. Run `task generate`
6. Write unit tests with `testify/require`
7. Add integration tests in `integration/` if needed

### Adding a CLI Command
1. Create command file in `cli/cmd/` following cobra pattern
2. Register in parent command
3. Add completion functions if needed
4. Update CLI tests
5. Run `task build` to verify

### Creating a Plugin
- Register capabilities via `endpoints.NewEndpoints(scheme)`
- Plugin must support `capabilities` and `server --config=<json>` commands
- Start with `plugin.NewPlugin(logger, config)` and `plugin.Start(ctx)`

### Modifying Component Descriptor Schema
1. Edit types in `bindings/go/descriptor/v2/`
2. Add `+ocm:jsonschema-gen=true` marker
3. Update normalization logic if needed
4. Run `task generate`
5. Update conformance tests in `testdata/`
6. Run `task test`

## CI Pipeline

On pull request:
1. Conventional commit validation
2. Auto-labeling by type/scope
3. Module discovery — tests run only for changed modules
4. Lint checks (`golangci-lint`)
5. Markdown and JSON schema validation

## Common Pitfalls

1. **Cross-module imports** — be careful with dependencies between `bindings/go/` modules
2. **Generated code** — always run `task generate` after marker changes
3. **Context** — always pass `context.Context` through APIs
4. **No interactive git** — do not use `-i` flags in scripts
5. **APIs are WIP** — expect changes, check existing patterns before adding new ones

## Debugging

```bash
./tmp/ocm --loglevel debug <command>          # CLI debug logging
./tmp/ocm get componentversion <comp> -o yaml # Inspect descriptors
task bindings/go/generator:jsonschemagen/test # Validate JSON schemas
```
